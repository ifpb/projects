---
import type { CollectionEntry } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import ProjectGrid from '@/components/ProjectGrid.astro';
import { getSubject } from '@/helpers/subjects';
import { getCourse } from '@/helpers/courses';
import { getAllProjectTags, getProjectsByTag } from '@/helpers/projects';
import { PAGE_SIZE } from '@/consts';

type ProjectsWithPeople = CollectionEntry<'projects'> & {
  people: CollectionEntry<'people'>[];
};

export interface Props {
  page: {
    data: ProjectsWithPeople[];
    currentPage: number;
    lastPage: number;
    url: {
      prev: string;
      next: string;
    };
  };
}

export async function getStaticPaths({ paginate }) {
  const tags: string[] = await getAllProjectTags();

  const page = await Promise.all(
    tags.flatMap(async (tag) => {
      const projects = await getProjectsByTag(tag);

      const pages = paginate(projects, {
        params: { tag },
        pageSize: PAGE_SIZE,
      });

      return pages;
    })
  );

  return page.flat();
}

const formatPageTitle = (tag: string) => {
  const types = {
    subject: 'Disciplina',
    research: 'Pesquisa',
    extension: 'Extens√£o',
    'open source': 'Open Source',
  };

  if (types[tag]) {
    return `Projetos | ${types[tag]}`;
  }

  const subjectWithPeriodMatch = tag.match(/^(.+)-(\d{4}\.?\d?)$/);
  if (subjectWithPeriodMatch) {
    const [, subjectId, period] = subjectWithPeriodMatch;
    const subjectEntry = getSubject(subjectId);

    if (subjectEntry) {
      return `Projetos | ${subjectEntry.data.name.full} (${period})`;
    }
  }

  const subjectEntry = getSubject(tag);
  if (subjectEntry) {
    return `Projetos | ${subjectEntry.data.name.full}`;
  }

  const courseEntry = getCourse(tag);
  if (courseEntry) {
    return `Projetos | ${courseEntry.data.level.compact} em ${courseEntry.data.name}`;
  }

  return `Projetos | ${tag.charAt(0).toUpperCase() + tag.slice(1)}`;
};

const { page }: Props = Astro.props;
const { tag } = Astro.params;
const pageTitle = formatPageTitle(tag);
---

<BaseLayout pageTitle={pageTitle}>
  <ProjectGrid page={page} type="codes" index={tag} />
</BaseLayout>
